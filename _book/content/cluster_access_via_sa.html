
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Accessing k8s with a service account Â· I code and I kube things</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-prism/prism-tomorrow.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-collapsible-chapters/collapsible-chapters.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-hints/plugin-hints.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-back-to-top-button/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fancybox/jquery.fancybox.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fancybox/jquery.fancybox-buttons.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-web-header/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="iks_fsck.html" />
    
    
    <link rel="prev" href="alpine_oc_cli.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        <li class="header">Introduction</li>
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                        <b>1.1.</b>
                    
                    What is this?
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Containers</li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="mac_podman.html">
            
                <a href="mac_podman.html">
            
                    
                        <b>2.1.</b>
                    
                    Run podman on MacOS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="alpine_oc_cli.html">
            
                <a href="alpine_oc_cli.html">
            
                    
                        <b>2.2.</b>
                    
                    Run OpenShift CLI on Alpine Linux
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Kubernetes</li>
        
        
    
        <li class="chapter active" data-level="3.1" data-path="cluster_access_via_sa.html">
            
                <a href="cluster_access_via_sa.html">
            
                    
                        <b>3.1.</b>
                    
                    Accessing k8s with a service account
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="iks_fsck.html">
            
                <a href="iks_fsck.html">
            
                    
                        <b>3.2.</b>
                    
                    IKS fsck errors
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="extract_tokenid.html">
            
                <a href="extract_tokenid.html">
            
                    
                        <b>3.3.</b>
                    
                    Extract token-id from KUBECONFIG
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.4" data-path="iks_kubelet_errors.html">
            
                <a href="iks_kubelet_errors.html">
            
                    
                        <b>3.4.</b>
                    
                    Debugging IKS kubelet errors
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.5" data-path="manual_se.html">
            
                <a href="manual_se.html">
            
                    
                        <b>3.5.</b>
                    
                    Manually creating service endpoints
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.6" data-path="priv_mk8s.html">
            
                <a href="priv_mk8s.html">
            
                    
                        <b>3.6.</b>
                    
                    Run privileged deployments on microk8s
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.7" data-path="sample_ingress.html">
            
                <a href="sample_ingress.html">
            
                    
                        <b>3.7.</b>
                    
                    Sample TLS Ingress
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.8" data-path="show_all.html">
            
                <a href="show_all.html">
            
                    
                        <b>3.8.</b>
                    
                    Show everying in a namespace
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.9" data-path="svc_proxy.html">
            
                <a href="svc_proxy.html">
            
                    
                        <b>3.9.</b>
                    
                    Access a service via kube proxy
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.10" data-path="k3s_taint.html">
            
                <a href="k3s_taint.html">
            
                    
                        <b>3.10.</b>
                    
                    Taint k3s masters for no user workloads
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">OpenShift</li>
        
        
    
        <li class="chapter " data-level="4.1" data-path="ocp_router_debug.html">
            
                <a href="ocp_router_debug.html">
            
                    
                        <b>4.1.</b>
                    
                    Debugging the OpenShift 4.x Router
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2" data-path="ocp_templates.html">
            
                <a href="ocp_templates.html">
            
                    
                        <b>4.2.</b>
                    
                    Managing Templates
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.3" data-path="ocp_min_clo.html">
            
                <a href="ocp_min_clo.html">
            
                    
                        <b>4.3.</b>
                    
                    Example ClusterLogging and LogForwarding APIs
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Istio</li>
        
        
    
        <li class="chapter " data-level="5.1" data-path="istio_danglers.html">
            
                <a href="istio_danglers.html">
            
                    
                        <b>5.1.</b>
                    
                    Cleaning up dangling webhooks
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.2" data-path="ibmcloud_managed_istio_update.html">
            
                <a href="ibmcloud_managed_istio_update.html">
            
                    
                        <b>5.2.</b>
                    
                    IBM Cloud Managed Istio upgrade test script
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.3" data-path="manual_istio_cleanup.html">
            
                <a href="manual_istio_cleanup.html">
            
                    
                        <b>5.3.</b>
                    
                    Manual Istio cleanup
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.4" data-path="istio_sidecars.html">
            
                <a href="istio_sidecars.html">
            
                    
                        <b>5.4.</b>
                    
                    Debugging Istio sidecars
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">IBM Cloud</li>
        
        
    
        <li class="chapter " data-level="6.1" data-path="ibmcloud_force_csi.html">
            
                <a href="ibmcloud_force_csi.html">
            
                    
                        <b>6.1.</b>
                    
                    Force VPC default storage class off
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.2" data-path="ibmcloud_private_catalog_new_offering.html">
            
                <a href="ibmcloud_private_catalog_new_offering.html">
            
                    
                        <b>6.2.</b>
                    
                    Add new offerings to a private catalog instance
            
                </a>
            

            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="7.1" >
            
                <a target="_blank" href="https://gist.github.com/jpapejr">
            
                    
                        <b>7.1.</b>
                    
                    Gists
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="7.2" >
            
                <a target="_blank" href="https://github.com/jpapejr?tab=repositories">
            
                    
                        <b>7.2.</b>
                    
                    Repos
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="7.3" data-path="../RESOURCES.html">
            
                <a href="../RESOURCES.html">
            
                    
                        <b>7.3.</b>
                    
                    Sample Resources
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Accessing k8s with a service account</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="accessing-a-k8s-cluster-with-a-service-account">Accessing a k8s cluster with a service account</h1>
<p>This method will allow you to set up a service account and create a context for it using kubectl config commands.</p>
<h2 id="create-a-service-account-in-your-cluster-any-namespace-works">Create a service account in your cluster (any namespace works)</h2>
<pre class="language-"><code>kubectl create sa <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>username</span><span class="token punctuation">&gt;</span></span>
</code></pre><h2 id="get-the-cert-and-token-info-from-the-new-service-account">Get the cert and token info from the new service account</h2>
<h3 id="certificate">Certificate</h3>
<pre class="language-"><code>kubectl get secret $(kubectl get sa jtp -o jsonpath=&apos;{.secrets[].name}&apos;) -o jsonpath=&apos;{.data.ca\.crt}&apos; | base64 -D &gt; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>path-to-new-ca-file</span><span class="token punctuation">&gt;</span></span>
</code></pre><h3 id="token">Token</h3>
<pre class="language-"><code>kubectl get secret $(kubectl get sa jtp -o jsonpath=&apos;{.secrets[].name}&apos;) -o jsonpath=&apos;{.data.token}&apos; | base64 -D
</code></pre><h2 id="create-a-clusterrolebinding-to-grant-the-permissions-you-want-to-give">Create a clusterrolebinding to grant the permissions you want to give</h2>
<pre class="language-"><code>kubectl create clusterrolebinding <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>clusterrolebinding</span> <span class="token attr-name">name</span><span class="token punctuation">&gt;</span></span> --clusterrole=<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>cluster-role</span><span class="token punctuation">&gt;</span></span> --serviceaccount=<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>service</span> <span class="token attr-name">account</span> <span class="token attr-name"><span class="token namespace">namespace:</span>service</span> <span class="token attr-name">account</span> <span class="token attr-name">name</span><span class="token punctuation">&gt;</span></span>
</code></pre><h2 id="create-a-new-kube-context">Create a new kube context</h2>
<h3 id="cluster">cluster</h3>
<pre class="language-"><code>kubectl config set-cluster <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>clustername</span><span class="token punctuation">&gt;</span></span> --server=<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>master</span> <span class="token attr-name">url</span> <span class="token attr-name">from</span> <span class="token attr-name">ibmcloud</span> <span class="token attr-name">ks</span> <span class="token attr-name">cluster-get</span> <span class="token attr-name">&lt;clustername</span><span class="token punctuation">&gt;</span></span>&gt; --certificate-authority=<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>path</span> <span class="token attr-name">to</span> <span class="token attr-name">the</span> <span class="token attr-name">ca</span> <span class="token attr-name">file</span> <span class="token attr-name">from</span> <span class="token attr-name">step</span> <span class="token attr-name">2</span><span class="token punctuation">&gt;</span></span>
</code></pre><h3 id="usercredentials">User/credentials</h3>
<pre class="language-"><code>kubectl config set-credentials <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>username</span><span class="token punctuation">&gt;</span></span> --token=<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>token</span> <span class="token attr-name">value</span> <span class="token attr-name">from</span> <span class="token attr-name">step</span> <span class="token attr-name">2b</span><span class="token punctuation">&gt;</span></span>
</code></pre><h3 id="context">Context</h3>
<pre class="language-"><code>kubectl config set-context <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>contextname</span><span class="token punctuation">&gt;</span></span> --cluster=<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>clustername</span><span class="token punctuation">&gt;</span></span> --user=<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>username</span><span class="token punctuation">&gt;</span></span>
</code></pre><p>From here you should be able to use normal kubectl commands to switch contexts/namespaces or you can use tools like kubectx and kubens from <a href="https://github.com/ahmetb/kubectx" target="_blank">https://github.com/ahmetb/kubectx</a>.</p>
<p>This method also allows for non-IAM users to have access to your cluster. (I.e. if you use this method, you don&#x2019;t have to grant any IBM Cloud users any IAM policies against your cluster or the Container service in general because you can create service accounts in-cluster for anyone and distributed the token and cert values to prospective users and they can use that (and standard k8s tooling) to set up their connection to the cluster.) Furthermore, you&#x2019;ll have the ability to restrict their access on the granularity of your choosing with clusterrolebindings (cluster level) and rolebindings (per namespace).</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="alpine_oc_cli.html" class="navigation navigation-prev " aria-label="Previous page: Run OpenShift CLI on Alpine Linux">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="iks_fsck.html" class="navigation navigation-next " aria-label="Next page: IKS fsck errors">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Accessing k8s with a service account","level":"3.1","depth":1,"next":{"title":"IKS fsck errors","level":"3.2","depth":1,"path":"content/iks_fsck.md","ref":"content/iks_fsck.md","articles":[]},"previous":{"title":"Run OpenShift CLI on Alpine Linux","level":"2.2","depth":1,"path":"content/alpine_oc_cli.md","ref":"content/alpine_oc_cli.md","articles":[]},"dir":"ltr"},"config":{"plugins":["prism","-highlight","collapsible-chapters","hints","copy-code-button","back-to-top-button","fancybox","web-header","livereload"],"root":"/","styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"webheader":{"headerTitle":"I code and I kube things"},"prism":{"css":["prismjs/themes/prism-tomorrow.css"]},"fancybox":{"helpers":{"buttons":{}},"openEffect":"elastic","closeEffect":"elastic"},"livereload":{},"web-header":{},"search":{},"collapsible-chapters":{},"hints":{"danger":"fa fa-exclamation-circle","info":"fa fa-info-circle","tip":"fa fa-mortar-board","working":"fa fa-wrench"},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"back-to-top-button":{},"copy-code-button":{},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":true}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"I code and I kube things","gitbook":"3.2.3"},"file":{"path":"content/cluster_access_via_sa.md","mtime":"2020-12-03T19:02:25.619Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2020-12-08T21:53:51.669Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-collapsible-chapters/collapsible-chapters.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-copy-code-button/toggle.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-back-to-top-button/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fancybox/jquery.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fancybox/jquery.mousewheel.pack.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fancybox/jquery.fancybox.pack.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fancybox/jquery.fancybox-buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fancybox/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-web-header/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-livereload/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

